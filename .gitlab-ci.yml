py_pve_cloud_upstream:
  stage: build
  image: docker.io/tobiashvmz/pve-cloud-ci:202601081028
  script:
    # write the new version
    - PESSIMISTIC_CONSTRAINT=$(/scripts/get-pessimistic-semver.sh $PY_PVE_CLOUD)
    - sed -i "s/^py-pve-cloud>=.*$/py-pve-cloud>=${PY_PVE_CLOUD},<${PESSIMISTIC_CONSTRAINT}/" requirements.txt
    - /scripts/upstream-push.sh "Update py-pve-cloud version to $PY_PVE_CLOUD (pessimistic)"
  rules:
    - if: '$PY_PVE_CLOUD != null && $PY_PVE_CLOUD != "" && $UPSTREAM_TAG_MESSAGE =~ /^release-.*/' # set by upstream

py_pve_cloud_rc_upstream:
  stage: build
  image: docker.io/tobiashvmz/pve-cloud-ci:202601081028
  script:
    # get the latest prod tag
    - new_tag=$(/scripts/get-new-tag.sh)
    - echo $new_tag
    # switch to rc branch
    - /scripts/rc-branch.sh $new_tag
    # set rc version for py-pve-cloud-dependency
    - sed -i "s/^py-pve-cloud.*$/py-pve-cloud==${PY_PVE_CLOUD//-/}/" requirements.txt
    - /scripts/upstream-push.sh "Set py-pve-cloud rc version to ${PY_PVE_CLOUD//-/}" "${new_tag}-rc" 
  rules:
    - if: '$PY_PVE_CLOUD != null && $PY_PVE_CLOUD != "" && $UPSTREAM_TAG_MESSAGE =~ /^rc-.*/' # set by upstream, trigger for rc release

release_tag:
  stage: build
  image: docker.io/tobiashvmz/pve-cloud-ci:202601081028
  script:
    - /scripts/release-tag.sh
  rules:
    - if: '$CI_COMMIT_TAG =~ /^release-[a-z]+$/'
  resource_group: deploy-prod

rc_tag:
  stage: build
  image: docker.io/tobiashvmz/pve-cloud-ci:202601081028
  script:
    - /scripts/rc-tag.sh
  rules:
    - if: '$CI_COMMIT_TAG =~ /^rc-[a-z]+$/'
  resource_group: deploy-prod

release_image:
  stage: deploy
  retry: 1 # even with check logic for pypi package rdy on index, calls after still sometimes fail
  image:
    name: quay.io/podman/stable:v5.7.1
  script:
    # exit if ci vars are not defined for building
    - |
      if [ -z $DOCKER_AUTH_CONFIG_B64 ]; then
        echo "Docker auth ci variable not defined!"
        exit 0
      fi
    - mkdir -p /root/.config/containers
    - echo $DOCKER_AUTH_CONFIG_B64 | base64 -d > /root/.config/containers/auth.json
    - echo "__version__ = \"$CI_COMMIT_TAG\"" > src/pve_cloud_backup/_version.py # dynamic versioning
    - podman build --layers --cache-from tobiashvmz/pve-cloud-backup-cache --cache-to tobiashvmz/pve-cloud-backup-cache -t tobiashvmz/pve-cloud-backup:$CI_COMMIT_TAG .
    - podman push tobiashvmz/pve-cloud-backup:$CI_COMMIT_TAG
  rules:
    - if: '$CI_COMMIT_TAG =~ /^\d+\.\d+\.\d+$/'
    - if: '$CI_COMMIT_TAG =~ /^\d+\.\d+\.\d+-rc\d+$/' # release candidate

publish_pypi:
  stage: deploy
  image:
    name: tobiashvmz/pve-cloud-pyci:2026010412
  script:
    # exit if ci vars are not defined for building
    - |
      if [ -z $PYPI_TOKEN ]; then
        echo "Pypi token ci variable not defined!"
        exit 0
      fi
    - echo "__version__ = \"$CI_COMMIT_TAG\"" > src/pve_cloud_backup/_version.py # dynamic versioning
    - python3 -m build
    - python3 -m twine upload dist/* -u __token__ -p $PYPI_TOKEN # skip gitlab oidc twine feature with -u and -p flags
  rules:
    - if: '$CI_COMMIT_TAG =~ /^\d+\.\d+\.\d+$/' # semver
    - if: '$CI_COMMIT_TAG =~ /^\d+\.\d+\.\d+-rc\d+$/' # release candidate

downstream_pve_cloud:
  stage: deploy
  trigger:
    project: "pve-cloud/pve_cloud"
  variables:
    PVE_CLOUD_BACKUP: $CI_COMMIT_TAG
    UPSTREAM_TAG_MESSAGE: $CI_COMMIT_TAG_MESSAGE # here we store the type of the release
  rules:
    - if: '$CI_COMMIT_TAG =~ /^\d+\.\d+\.\d+$/' # semver
    - if: '$CI_COMMIT_TAG =~ /^\d+\.\d+\.\d+-rc\d+$/' # release candidate

downstream_tf_backup_module:
  stage: deploy
  trigger:
    project: "pve-cloud/terraform-pxc-backup"
  variables:
    PVE_CLOUD_BACKUP: $CI_COMMIT_TAG
    UPSTREAM_TAG_MESSAGE: $CI_COMMIT_TAG_MESSAGE # here we store the type of the release
  rules:
    - if: '$CI_COMMIT_TAG =~ /^\d+\.\d+\.\d+$/' # semver
    - if: '$CI_COMMIT_TAG =~ /^\d+\.\d+\.\d+-rc\d+$/' # release candidate

format_source:
  stage: build
  image: tobiashvmz/pve-cloud-pyci:2026010412
  script:
    - git config --global user.name "$GITLAB_USER_NAME"
    - git config --global user.email "$GITLAB_USER_EMAIL"
    - autoflake --in-place --recursive .
    - black .
    - isort .
    # commit the changes
    - |
      if ! git diff --quiet; then
        git add .
        git commit -m "Format and cleanup pipeline"
        git push origin HEAD:$CI_COMMIT_REF_NAME
      else
        echo "Nothing to clean or format!"
      fi
  rules:
    - if: >
        $CI_COMMIT_TAG !~ /^\d+\.\d+\.\d+$/ &&
        $CI_COMMIT_TAG !~ /^\d+\.\d+\.\d+-rc\d+$/ &&
        $CI_COMMIT_TAG !~ /^release-[a-z]+$/ &&
        $CI_COMMIT_TAG !~ /^rc-[a-z]+$/ &&
        $CI_PIPELINE_SOURCE == 'push'
      when: on_success
    - when: never
  resource_group: deploy-prod